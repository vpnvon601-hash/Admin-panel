<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Admin — LA ZONA DEL BARBERO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --bg: #0a0a0c;
    --card: rgba(255,255,255,0.05);
    --border: rgba(255,255,255,0.10);
    --text: #ffffff;
    --muted: #9aa0a6;
    --danger: #ff4d4d;
    --accent: #f6c358;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Inter", Arial;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 22px;
  }

  h2 {
    font-weight: 600;
    margin-bottom: 12px;
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    padding: 18px;
    border-radius: 14px;
    backdrop-filter: blur(12px);
    margin-bottom: 14px;
  }

  /* ESTILO PARA LABELS (NUEVO) */
  label {
    display: block;
    color: var(--muted);
    font-size: 14px;
    margin-top: 14px;
    margin-bottom: -6px;
  }

  input {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    font-size: 16px;
    margin-top: 8px;
  }

  .btn {
    width: 100%;
    margin-top: 12px;
    padding: 12px;
    background: var(--accent);
    border: none;
    border-radius: 12px;
    color: #0a0a0c;
    font-weight: 700;
    cursor: pointer;
    font-size: 16px;
  }

  .btn:active {
    transform: scale(0.98);
    transition: 0.15s;
  }
  
  .btn-secondary {
    background: rgba(255,255,255,0.08) !important;
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.16);
  }

  .btn-delete {
    margin-top: 10px;
    background: var(--danger);
    border: none;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    color: white;
  }
</style>
</head>
<body>

<div id="loginBox" class="card">
  <h2>Acceso de Barbero</h2>
  <p style="color: var(--muted); margin-top: -6px;">Ingresa tu usuario y contraseña.</p>

  <label for="usuario">Usuario</label>
  <input type="text" id="usuario" placeholder="Tu nombre de Barbero">
  
  <label for="password">Contraseña</label>
  <input type="password" id="password" placeholder="Contraseña de acceso">
  
  <button class="btn" id="btnLogin">Entrar</button>

  <p id="msg" style="color:#ff7777; font-size:14px; margin-top:6px;"></p>
</div>

<div id="panel" style="display:none;">
  <h2 id="panelTitle">Citas Agendadas</h2>
  <button id="btnLogout" class="btn btn-secondary" style="width:auto; margin-top:0; margin-bottom:14px;">Cerrar Sesión</button>
  <div id="lista"></div>
</div>

<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  // --- TU FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
    authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
    databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
    projectId: "lazonadelbarbero-b4e75",
    storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
    messagingSenderId: "251180096928",
    appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
    measurementId: "G-G4YL7M4Z00"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const loginBox = document.getElementById("loginBox");
  const panel    = document.getElementById("panel");
  const lista    = document.getElementById("lista");
  const panelTitle = document.getElementById("panelTitle");
  const btnLogout = document.getElementById("btnLogout");

  // ************************************
  // ** CREDENCIALES DE BARBEROS (NUEVO) **
  // ************************************
  const BARBER_CREDENTIALS = {
    // Usuario: Contraseña (¡Modifica estas contraseñas!)
    "Dylan": "dylan123",
    "Santiago": "santi456",
    "Alejandro": "ale789",
    "Leonardo": "leo000"
  };
  
  let loggedInBarbero = null; // Almacena el nombre del barbero loggeado

  // Convertir minutos a hora iPhone AM/PM
  function minutesToTime(min) {
    const h = Math.floor(min / 60);
    const m = min % 60;
    const ampm = h >= 12 ? "PM" : "AM";
    const hour12 = h % 12 === 0 ? 12 : h % 12;
    return `${hour12}:${String(m).padStart(2, "0")} ${ampm}`;
  }

  // ************************************
  // ** LÓGICA DE LOGIN (MODIFICADA) **
  // ************************************
  document.getElementById("btnLogin").addEventListener("click", () => {
    const usuario = document.getElementById("usuario").value.trim();
    const password = document.getElementById("password").value.trim();
    const msgEl = document.getElementById("msg");

    if (BARBER_CREDENTIALS[usuario] === password) {
      loggedInBarbero = usuario;
      loginBox.style.display = "none";
      panel.style.display = "block";
      panelTitle.textContent = `Citas de ${loggedInBarbero}`;
      cargarCitas();
    } else {
      msgEl.innerHTML = "Usuario o Contraseña incorrectos";
    }
  });

  // ************************************
  // ** LÓGICA DE LOGOUT (NUEVA) **
  // ************************************
  btnLogout.addEventListener("click", () => {
    loggedInBarbero = null;
    document.getElementById("usuario").value = "";
    document.getElementById("password").value = "";
    document.getElementById("msg").innerHTML = "";
    panel.style.display = "none";
    loginBox.style.display = "block";
    
    // Aquí se debería detener el listener de Firebase,
    // pero para este ejemplo simple, solo se oculta la vista.
  });


  // ************************************
  // ** CARGAR CITAS (MODIFICADA PARA FILTRAR) **
  // ************************************
  function cargarCitas() {
    if (!loggedInBarbero) return; 

    // Referencia solo a las citas del barbero loggeado
    const refCitas = ref(db, `appointments/${loggedInBarbero}`);
    lista.innerHTML = "<p style='color:var(--muted);'>Cargando citas...</p>";

    onValue(refCitas, snap => {
      lista.innerHTML = "";
      const data = snap.val(); 

      if (!data) {
        lista.innerHTML = `<p style='color:var(--muted);'>No tienes citas agendadas, ${loggedInBarbero}.</p>`;
        return;
      }

      const allAppointments = [];

      // La estructura ahora es {fecha: {id: cita, ...}, ...}
      for (const fecha in data) {
        for (const id in data[fecha]) {
          const c = data[fecha][id];
          c.fecha = fecha; // Añadir fecha y ID para la referencia de borrado
          c.id = id;
          allAppointments.push(c);
        }
      }

      // Ordenar por fecha y luego por hora de inicio
      allAppointments.sort((a, b) => {
        const dateA = new Date(a.fecha).getTime() + a.startMinutes * 60000;
        const dateB = new Date(b.fecha).getTime() + b.startMinutes * 60000;
        return dateA - dateB;
      });

      // Renderizar citas
      for (const c of allAppointments) {
        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <strong style="font-size:18px;">${c.nombre}</strong><br>
          <span style="color:var(--muted);">Servicio:</span> ${c.servicio}<br>
          <span style="color:var(--muted);">Fecha:</span> ${c.fecha}<br>
          <span style="color:var(--muted);">Hora:</span> ${minutesToTime(c.startMinutes)}<br>
          <span style="color:var(--muted);">Duración:</span> ${c.durationMinutes} min<br>
          <span style="color:var(--muted);">Tel:</span> ${c.telefono}<br>
          <span style="color:var(--muted);">Precio:</span> $${c.priceCOP ? c.priceCOP.toLocaleString('es-CO') : 'N/A'}<br>
          <span style="color:var(--muted);">Creado:</span> ${new Date(c.createdAt).toLocaleDateString('es-CO', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'})}<br>

          <button class="btn-delete">Eliminar</button>
        `;

        // Botón eliminar
        div.querySelector(".btn-delete").addEventListener("click", async () => {
          if (confirm("¿Eliminar esta cita?")) {
            // La ruta ahora usa el barbero loggeado (implícito), la fecha y el ID
            await remove(ref(db, `appointments/${loggedInBarbero}/${c.fecha}/${c.id}`));
          }
        });

        lista.appendChild(div);
      }
    });
  }

</script>

</body>
</html>
