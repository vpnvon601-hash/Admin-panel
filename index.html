<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LA ZONA DEL BARBERO ‚Äî Panel Admin</title>
    <style>
        /* Estilos base (copiados para consistencia) */
        :root{
            --bg:#06070a; --card:#0e1115; --muted:#9aa0a6; --line:#1e252b;
            --text:#e6eef3; --accent:#f6c358; --accent-2:#7be3a8; --glass:rgba(255,255,255,0.03);
            --danger:#ef6b6b; --good:#35d19b;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#030304 0%,#071018 100%);color:var(--text);-webkit-font-smoothing:antialiased; padding:20px;}
        .container{max-width:900px;margin:auto;}
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:var(--radius);border:1px solid var(--line);box-shadow:0 6px 30px rgba(0,0,0,0.6); margin-bottom: 20px;}
        h2{color:var(--accent); text-align:center;}
        h3{margin:0 0 12px 0;font-weight:700}
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px; margin-top: 10px;}
        input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);font-size:15px}
        button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071018;border:none;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 8px 20px rgba(123,227,168,0.06); width: 100%; margin-top: 20px;}
        button.secondary{background:transparent;color:var(--text);border:1px solid var(--line);padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700; width: 100%; margin-top: 10px;}
        .row{display:flex;gap:10px;}
        .message{padding:10px;border-radius:10px;margin-top:10px;font-size:14px; display:none;}
        .success{background:rgba(53, 209, 155, 0.1); color:var(--good); border:1px solid var(--good);}
        .error{background:rgba(239, 107, 107, 0.1); color:var(--danger); border:1px solid var(--danger);}
        .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid var(--line);border-top-color:var(--accent);animation:spin .9s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Estilos de lista de citas */
        .appointment-table-container{overflow-x:auto;}
        .appointment-table{width:100%; border-collapse: collapse; margin-top:15px;}
        .appointment-table th, .appointment-table td{padding:10px 12px; text-align: left; border-bottom:1px solid var(--line); font-size:14px;}
        .appointment-table th{background:rgba(255,255,255,0.03); font-weight:700; color:var(--accent-2);}
        .appointment-table tr:hover{background:rgba(255,255,255,0.01);}
        .appointment-table .phone-link{white-space:nowrap; color:var(--accent); text-decoration:none; font-weight: 600;}
        .appointment-table .date-created{font-size:10px; color:var(--muted); white-space:nowrap;}
        .appointment-table td.action-col { width: 1%; white-space: nowrap; }
        .action-btn{ padding:6px 10px; font-size:12px; margin:2px; display:inline-block; border-radius:6px; cursor:pointer;}
        .delete-btn{ background:var(--danger); color:white; border:none; }
        .edit-btn{ background:var(--muted); color:#071018; border:none; }
        
        /* Ausencias */
        .list-container{border:1px solid var(--line); border-radius:var(--radius); padding:10px; max-height: 250px; overflow-y: auto; margin-top:10px;}
        .period-item{padding:8px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
        .period-item:last-child{border-bottom:none;}
        .delete-btn.absence{background:var(--danger); color:white; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; font-size:12px;}

        /* Header */
        header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:10px 0; border-bottom: 1px solid var(--line);}
        header h3{margin:0; color:var(--accent-2);}
        .user-info{font-size:14px; color:var(--muted);}
        .logout-btn{padding:8px 12px; font-size:14px; cursor:pointer;}
    </style>
</head>
<body>
    <div class="container">
        <h2>üíà Panel de Administraci√≥n ‚Äî LA ZONA DEL BARBERO</h2>

        <div id="loginContainer" class="card" style="max-width:400px; margin: 40px auto;">
            <h3>üîë Iniciar Sesi√≥n</h3>
            <div id="loginMessage" class="message"></div>
            
            <label for="username">Usuario</label>
            <input id="username" type="text" placeholder="Tu usuario">

            <label for="password">Contrase√±a</label>
            <input id="password" type="password" placeholder="Tu contrase√±a">

            <button class="primary" id="btnLogin">Acceder al Panel</button>
            <p style="text-align:center; font-size:12px; color:var(--muted); margin-top:15px;">**Usuarios de Prueba:**<br>Dilan: dilan_admin / DilanPassword123</p>
        </div>

        <div id="dashboardContainer" style="display:none;">
            <header>
                <div class="user-info">Sesi√≥n iniciada como: <strong id="barberNameDisplay"></strong></div>
                <button id="btnLogout" class="secondary logout-btn">Cerrar Sesi√≥n</button>
            </header>
            
            <div class="card">
                <h3 style="display:flex; justify-content:space-between; align-items:center;">
                    üìÖ Tus Citas Agendadas
                    <span id="appointmentCount" style="font-size:14px; color:var(--accent);"></span>
                </h3>

                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <label for="filterDate">Buscar/Filtrar por Fecha:</label>
                        <input id="filterDate" type="date">
                    </div>
                    <button id="clearDateFilter" class="secondary" style="width:auto; padding:12px 14px; margin:0;">Mostrar Todo</button>
                </div>
                
                <div id="appointmentList" class="appointment-table-container">
                    <p style="text-align:center; color:var(--muted);">Cargando citas...</p>
                </div>
            </div>

            <div class="card">
                <h3>‚õî Marcar Ausencia Personal</h3>
                <div id="absenceMessage" class="message"></div>

                <div class="row">
                    <div style="flex:1;">
                        <label for="startDate">Fecha de Inicio *</label>
                        <input id="startDate" type="date">
                    </div>
                    <div style="flex:1;">
                        <label for="endDate">Fecha de Fin *</label>
                        <input id="endDate" type="date">
                    </div>
                </div>

                <label for="reason">Raz√≥n de la Ausencia</label>
                <input id="reason" type="text" placeholder="Ej: Vacaciones, d√≠a libre, etc. (Opcional)">

                <button class="primary" id="btnSaveAbsence">Guardar Periodo de Ausencia</button>
            </div>

            <div class="card">
                <h3>üìÖ Ausencias Programadas (Tus Ausencias)</h3>
                <div id="absenceListContainer" class="list-container">
                    <p style="text-align:center; color:var(--muted);">Cargando ausencias...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        // Importamos 'set' para guardar, 'get' para leer, y 'remove' para eliminar
        import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase config (DEBE SER LA MISMA que en el index (2).html)
        const firebaseConfig = {
          apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
          authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
          databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
          projectId: "lazonadelbarbero-b4e75",
          storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
          messagingSenderId: "251180096928",
          appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
          measurementId: "G-G4YL7M4Z00"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ** Hardcoded Credentials ** (CAMBIAR INMEDIATAMENTE EN PRODUCCI√ìN)
        const BARBER_CREDENTIALS = {
            "dilan_admin": { password: "Dilan123", name: "Dilan" },
            "alejo_admin": { password: "Alejo123", name: "Alejandro" },
            "leo_admin": { password: "Leo123", name: "Leonardo" },
            "santi_admin": { password: "Santi1011", name: "Santiago" }
        };
        
        let LOGGED_IN_BARBER = localStorage.getItem('loggedBarber') || null;

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const barberNameDisplay = document.getElementById('barberNameDisplay');
        const appointmentList = document.getElementById('appointmentList');
        const appointmentCount = document.getElementById('appointmentCount');

        // Login DOM
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const btnLogin = document.getElementById('btnLogin');
        const loginMessageEl = document.getElementById('loginMessage');
        const btnLogout = document.getElementById('btnLogout');

        // Absence DOM
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const reasonEl = document.getElementById('reason');
        const btnSaveAbsence = document.getElementById('btnSaveAbsence');
        const absenceMessageEl = document.getElementById('absenceMessage');
        const absenceListContainer = document.getElementById('absenceListContainer');
        
        // NEW: Filter DOM
        const filterDateEl = document.getElementById('filterDate');
        const clearDateFilterBtn = document.getElementById('clearDateFilter');


        // --- UTILS ---
        function minutesToAmPmWithSpace(m){
            let hh = Math.floor(m/60); const mm = String(m%60).padStart(2,'0');
            const ampm = hh >= 12 ? 'PM' : 'AM'; hh = hh % 12; if(hh===0) hh=12;
            return `${hh}:${mm} ${ampm}`;
        }
        function formatFirebaseDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('es-CO', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace('.', '');
        }

        // --- MESSAGE HANDLERS ---
        function showMessage(element, type, text) {
            element.classList.remove('success', 'error');
            element.classList.add(type);
            element.textContent = text;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }

        // --- AUTHENTICATION LOGIC ---
        function checkLoginState() {
            if (LOGGED_IN_BARBER) {
                barberNameDisplay.textContent = LOGGED_IN_BARBER;
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                loadDashboardData(LOGGED_IN_BARBER);
                // Attach event listeners for filtering here
                filterDateEl.addEventListener('change', () => displayAppointments(LOGGED_IN_BARBER));
                clearDateFilterBtn.addEventListener('click', () => {
                    filterDateEl.value = '';
                    displayAppointments(LOGGED_IN_BARBER);
                });
            } else {
                loginContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                usernameEl.value = '';
                passwordEl.value = '';
                usernameEl.focus();
            }
        }

        btnLogin.addEventListener('click', () => {
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            
            const user = BARBER_CREDENTIALS[username];

            if(user && user.password === password) {
                LOGGED_IN_BARBER = user.name;
                localStorage.setItem('loggedBarber', LOGGED_IN_BARBER);
                showMessage(loginMessageEl, 'success', `Bienvenido, ${LOGGED_IN_BARBER}.`);
                checkLoginState();
            } else {
                showMessage(loginMessageEl, 'error', 'Usuario o contrase√±a incorrectos.');
            }
        });

        btnLogout.addEventListener('click', () => {
            LOGGED_IN_BARBER = null;
            localStorage.removeItem('loggedBarber');
            showMessage(loginMessageEl, 'success', 'Sesi√≥n cerrada. Vuelve pronto.');
            checkLoginState();
        });
        
        // --- DASHBOARD DATA LOADING ---

        async function loadDashboardData(barbero) {
            await displayAppointments(barbero);
            await displayAbsences(barbero);
        }

        // --- APPOINTMENT LIST LOGIC ---

        async function fetchBarberAppointments(barbero) {
            const appointmentsRef = ref(db, `appointments/${barbero}`);
            const snap = await get(appointmentsRef);
            const allAppointments = [];

            if (snap.exists()) {
                const datesData = snap.val();
                for (const dateISO in datesData) {
                    const appointmentsOnDate = datesData[dateISO];
                    for (const key in appointmentsOnDate) {
                        const appt = appointmentsOnDate[key];
                        appt.dateISO = dateISO;
                        appt.id = key; // El ID es la hora de inicio en minutos
                        allAppointments.push(appt);
                    }
                }
            }
            // Sort by date (oldest first) and then by start time
            allAppointments.sort((a, b) => {
                if (a.dateISO > b.dateISO) return 1;
                if (a.dateISO < b.dateISO) return -1;
                return a.startMinutes - b.startMinutes;
            });

            return allAppointments;
        }

        async function displayAppointments(barbero) {
            appointmentList.innerHTML = '<p style="text-align:center;"><span class="loader"></span> Cargando citas...</p>';
            const filterDate = filterDateEl.value; // Obtener el valor del filtro
            
            try {
                const allAppointments = await fetchBarberAppointments(barbero);
                
                // Aplicar Filtro de Fecha
                let appointments = allAppointments;
                if (filterDate) {
                    appointments = allAppointments.filter(appt => appt.dateISO === filterDate);
                }

                appointmentCount.textContent = `(${appointments.length} Citas)`;

                if (appointments.length === 0) {
                    appointmentList.innerHTML = `<p style="text-align:center; color:var(--muted);">No hay citas agendadas ${filterDate ? 'para la fecha seleccionada' : ''} para ti, ${barbero}.</p>`;
                    return;
                }

                let tableHTML = `
                    <table class="appointment-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Tel√©fono</th>
                                <th>Servicio</th>
                                <th>Fecha y Hora</th>
                                <th>Creada</th>
                                <th>Acciones</th> 
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                appointments.forEach(appt => {
                    const horaNice = minutesToAmPmWithSpace(appt.startMinutes);
                    const isPassed = appt.dateISO < new Date().toISOString().split('T')[0] || (appt.dateISO === new Date().toISOString().split('T')[0] && appt.endMinutes < (new Date().getHours() * 60 + new Date().getMinutes()));
                    const rowStyle = isPassed ? 'style="opacity: 0.5; text-decoration: line-through;"' : '';
                    
                    const fullName = appt.nombre || 'N/A';
                    const nameParts = fullName.split(' ');
                    const firstName = nameParts[0];
                    const lastName = nameParts.slice(1).join(' ');

                    tableHTML += `
                        <tr ${rowStyle}>
                            <td>${firstName} <br><strong>${lastName}</strong></td>
                            <td>
                                <a href="https://wa.me/${appt.telefono}" target="_blank" class="phone-link">
                                    ${appt.telefono} üì≤
                                </a>
                            </td>
                            <td>${appt.servicio} (${appt.durationMinutes}m)</td>
                            <td>
                                ${appt.dateISO} 
                                <br>
                                <strong>${horaNice}</strong>
                            </td>
                            <td><span class="date-created">${formatFirebaseDate(appt.createdAt)}</span></td>
                            <td class="action-col">
                                <button class="action-btn delete-btn" 
                                    data-barbero="${barbero}" 
                                    data-date="${appt.dateISO}" 
                                    data-appt-id="${appt.id}" 
                                    title="Eliminar la cita">
                                    üóëÔ∏è Eliminar
                                </button>
                                <a href="https://wa.me/${appt.telefono}" target="_blank" class="action-btn edit-btn" title="Contactar al cliente para editar/reagendar">
                                    ‚úèÔ∏è Editar
                                </a>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `</tbody></table>`;
                appointmentList.innerHTML = tableHTML;
                
                // A√±adir listeners al bot√≥n de eliminar
                appointmentList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteAppointment);
                });
                
            } catch(error) {
                console.error("Error fetching appointments:", error);
                appointmentList.innerHTML = '<p style="text-align:center; color:var(--danger);">Error cargando citas.</p>';
            }
        }

        // --- NEW: DELETE APPOINTMENT LOGIC ---
        async function handleDeleteAppointment(event) {
            if(!confirm('¬øEst√°s seguro de que quieres ELIMINAR esta cita? Esta acci√≥n es irreversible.')) return;
            
            const button = event.target;
            const barbero = button.dataset.barbero;
            const dateISO = button.dataset.date;
            const appointmentId = button.dataset.apptId; // La hora en minutos

            if(!barbero || !dateISO || !appointmentId) {
                alert('Error interno: Faltan datos de la cita.');
                return;
            }
            
            button.disabled = true;
            button.textContent = '...';

            try {
                // Path: appointments/{barbero}/{dateISO}/{appointmentId}
                const path = `appointments/${barbero}/${dateISO}/${appointmentId}`;
                await remove(ref(db, path));
                
                showMessage(loginMessageEl, 'success', `Cita del ${dateISO} eliminada correctamente.`);
                await displayAppointments(barbero); // Refrescar la lista
            } catch(error) {
                console.error("Error deleting appointment:", error);
                showMessage(loginMessageEl, 'error', 'Error al eliminar la cita. Revisa la consola.');
            }
        }


        // --- ABSENCE LOGIC (Adapted for Logged-in Barber) ---
        // (Mantenida de la versi√≥n anterior)

        // Function to fetch absences
        async function fetchUnavailableDates(barbero){
            const path = `unavailableDates/${barbero}`;
            const snap = await get(child(ref(db), path));
            if(snap.exists()){
                return snap.val();
            }
            return {};
        }

        // Function to display absences
        async function displayAbsences(barbero) {
            absenceListContainer.innerHTML = '<p style="text-align:center;"><span class="loader"></span> Cargando...</p>';
            try {
                const data = await fetchUnavailableDates(barbero);
                
                if(!data || Object.keys(data).length === 0) {
                    absenceListContainer.innerHTML = `<p style="text-align:center; color:var(--muted);">No hay ausencias programadas para ti.</p>`;
                    return;
                }

                let html = '';
                // Ordenar por fecha de inicio (la clave)
                const sortedKeys = Object.keys(data).sort(); 

                sortedKeys.forEach(startDate => {
                    const period = data[startDate];
                    const endDate = period.endDate;
                    const reason = period.reason;
                    const today = new Date().toISOString().split('T')[0];
                    
                    const isPast = endDate < today;
                    const style = isPast ? 'opacity: 0.6; text-decoration: line-through;' : '';
                    
                    html += `
                        <div class="period-item" style="${style}">
                            <div>
                                <strong>${startDate}</strong> al <strong>${endDate}</strong> 
                                <span style="color:var(--accent); margin-left: 8px;">(${reason})</span>
                                ${isPast ? '<span style="color:var(--danger); font-size:11px;">(Pasado)</span>' : ''}
                            </div>
                            <button class="delete-btn absence" data-barbero="${barbero}" data-startdate="${startDate}">Eliminar</button>
                        </div>
                    `;
                });
                
                absenceListContainer.innerHTML = html;
                
                // Agregar listeners para el bot√≥n de eliminar
                absenceListContainer.querySelectorAll('.delete-btn.absence').forEach(button => {
                    button.addEventListener('click', handleDeleteAbsence);
                });

            } catch(error) {
                console.error("Error displaying absences:", error);
                absenceListContainer.innerHTML = '<p style="text-align:center; color:var(--danger);">Error cargando ausencias.</p>';
            }
        }

        // Function to handle saving absence
        btnSaveAbsence.addEventListener('click', async () => {
            const barbero = LOGGED_IN_BARBER; // Usa el barbero logueado
            const startDate = startDateEl.value;
            const endDate = endDateEl.value;
            const reason = reasonEl.value.trim();
            
            if(!barbero || !startDate || !endDate){
                showMessage(absenceMessageEl, 'error', 'Por favor, selecciona la fecha de inicio y fecha de fin.');
                return;
            }

            if(startDate > endDate){
                showMessage(absenceMessageEl, 'error', 'La fecha de inicio no puede ser posterior a la fecha de fin.');
                return;
            }
            
            btnSaveAbsence.disabled = true;
            btnSaveAbsence.innerHTML = 'Guardando... <span class="loader"></span>';

            try {
                const path = `unavailableDates/${barbero}/${startDate}`;
                const data = {
                    endDate: endDate,
                    reason: reason || 'Ausencia programada'
                };

                await set(ref(db, path), data);
                
                showMessage(absenceMessageEl, 'success', `Ausencia guardada correctamente del ${startDate} al ${endDate}.`);
                
                // Limpiar formulario y refrescar lista
                startDateEl.value = '';
                endDateEl.value = '';
                reasonEl.value = '';
                await displayAbsences(barbero);
                
            } catch(error) {
                console.error("Error saving absence:", error);
                showMessage(absenceMessageEl, 'error', 'Error al guardar la ausencia. Revisa la consola.');
            } finally {
                btnSaveAbsence.disabled = false;
                btnSaveAbsence.textContent = 'Guardar Periodo de Ausencia';
            }
        });

        // Function to handle deleting absence
        async function handleDeleteAbsence(event) {
            if(!confirm('¬øEst√°s seguro de que quieres eliminar este periodo de ausencia?')) return;
            
            const button = event.target;
            const barbero = button.dataset.barbero;
            const startDate = button.dataset.startdate;
            
            button.disabled = true;
            button.textContent = '...';

            try {
                const path = `unavailableDates/${barbero}/${startDate}`;
                await remove(ref(db, path));
                showMessage(absenceMessageEl, 'success', `Ausencia del ${startDate} eliminada correctamente.`);
                await displayAbsences(barbero); // Refrescar la lista
            } catch(error) {
                console.error("Error deleting absence:", error);
                showMessage(absenceMessageEl, 'error', 'Error al eliminar la ausencia.');
            } finally {
                button.disabled = false;
                button.textContent = 'Eliminar';
            }
        }

        // Inicializaci√≥n
        checkLoginState();

    </script>
</body>
</html>
