<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LA ZONA DEL BARBERO ‚Äî Panel Admin</title>
    <style>
        /* Estilos base (copiados para consistencia) */
        :root{
            --bg:#06070a; --card:#0e1115; --muted:#9aa0a6; --line:#1e252b;
            --text:#e6eef3; --accent:#f6c358; --accent-2:#7be3a8; --glass:rgba(255,255,255,0.03);
            --danger:#ef6b6b; --good:#35d19b;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#030304 0%,#071018 100%);color:var(--text);-webkit-font-smoothing:antialiased; padding:20px;}
        .container{max-width:900px;margin:auto;}
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:var(--radius);border:1px solid var(--line);box-shadow:0 6px 30px rgba(0,0,0,0.6); margin-bottom: 20px;}
        h2{color:var(--accent); text-align:center;}
        h3{margin:0 0 12px 0;font-weight:700}
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px; margin-top: 10px;}
        input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);font-size:15px}
        button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071018;border:none;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 8px 20px rgba(123,227,168,0.06); width: 100%; margin-top: 20px;}
        button.secondary{background:transparent;color:var(--text);border:1px solid var(--line);padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700; width: 100%; margin-top: 10px;}
        .row{display:flex;gap:10px;}
        .message{padding:10px;border-radius:10px;margin-top:10px;font-size:14px; display:none; margin-bottom: 10px;} 
        .success{background:rgba(53, 209, 155, 0.1); color:var(--good); border:1px solid var(--good);}
        .error{background:rgba(239, 107, 107, 0.1); color:var(--danger); border:1px solid var(--danger);}
        .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid var(--line);border-top-color:var(--accent);animation:spin .9s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Estilos de lista de citas */
        .appointment-table-container{overflow-x:auto;}
        .appointment-table{width:100%; border-collapse: collapse; margin-top:15px;}
        .appointment-table th, .appointment-table td{padding:10px 12px; text-align: left; border-bottom:1px solid var(--line); font-size:14px;}
        .appointment-table th{background:rgba(255,255,255,0.03); font-weight:700; color:var(--accent-2);}
        .appointment-table tr:hover{background:rgba(255,255,255,0.01);}
        .appointment-table .phone-link{white-space:nowrap; color:var(--accent); text-decoration:none; font-weight: 600;}
        .appointment-table .date-created{font-size:10px; color:var(--muted); white-space:nowrap;}
        .appointment-table td.action-col { width: 1%; white-space: nowrap; }
        .action-btn{ padding:6px 10px; font-size:12px; margin:2px; display:inline-block; border-radius:6px; cursor:pointer;}
        .delete-btn{ background:var(--danger); color:white; border:none; }
        .edit-btn{ background:var(--muted); color:#071018; border:none; }
        /* Nuevo estilo para completadas */
        .complete-btn{ background:var(--good); color:#071018; border:none; }
        .completed-row { opacity: 0.5; background-color: rgba(53, 209, 155, 0.05); }
        .completed-text { text-decoration: line-through; }
        
        /* Ausencias */
        .list-container{border:1px solid var(--line); border-radius:var(--radius); padding:10px; max-height: 250px; overflow-y: auto; margin-top:10px;}
        .period-item{padding:8px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
        .period-item:last-child{border-bottom:none;}
        .delete-btn.absence{background:var(--danger); color:white; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; font-size:12px;}

        /* Header */
        header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:10px 0; border-bottom: 1px solid var(--line);}
        header h3{margin:0; color:var(--accent-2);}
        .user-info{font-size:14px; color:var(--muted);}
        .logout-btn{padding:8px 12px; font-size:14px; cursor:pointer;}
        
        /* Nuevo para estados de asistencia */
        .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; white-space: nowrap; display: inline-block; }
        .status-absent { background-color: var(--danger); color: white; }
        .status-present { background-color: var(--good); color: #071018; }
        .status-warning { background-color: var(--accent); color: #071018; }

    </style>
</head>
<body>
    <div class="container">
        <h2 style="margin-bottom: 20px; margin-top: 10px;">Panel de Administraci√≥n ‚Äî LA ZONA DEL BARBERO</h2>
        <div id="loginContainer" class="card" style="max-width:400px; margin: 40px auto;">
            <h3>üîë Iniciar Sesi√≥n</h3>
            <div id="loginMessage" class="message"></div>
            
            <label for="username">Usuario</label>
            <input id="username" type="text" placeholder="Tu usuario">

            <label for="password">Contrase√±a</label>
            <input id="password" type="password" placeholder="Tu contrase√±a">

            <button class="primary" id="btnLogin">Acceder al Panel</button>
            <p style="text-align:center; font-size:12px; color:var(--muted); margin-top:15px;">**Usuarios de Prueba:**<br>Dilan: dilan_admin / Dilan123</p>
        </div>

        <div id="dashboardContainer" style="display:none;">
            <header>
                <div class="user-info">Sesi√≥n iniciada como: <strong id="barberNameDisplay"></strong></div>
                <button id="btnLogout" class="secondary logout-btn">Cerrar Sesi√≥n</button>
            </header>
            
            <div id="notificationBanner" class="message success" style="display: none; font-weight: 700;"></div>

            <div class="card">
                <h3 style="display:flex; justify-content:space-between; align-items:center;">
                    üìÖ Tus Citas Agendadas
                    <span id="appointmentCount" style="font-size:14px; color:var(--accent);"></span>
                </h3>

                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <label for="filterDate">Buscar/Filtrar por Fecha:</label>
                        <input id="filterDate" type="date">
                    </div>
                    <button id="clearDateFilter" class="secondary" style="width:auto; padding:12px 14px; margin:0;">Mostrar Todo</button>
                </div>
                
                <div id="appointmentList" class="appointment-table-container">
                    <p style="text-align:center; color:var(--muted);">Cargando citas...</p>
                </div>
            </div>

            <div class="card">
                <h3>‚õî Marcar Ausencia por D√≠as Completos</h3>
                <div id="absenceMessage" class="message"></div>

                <div class="row">
                    <div style="flex:1;">
                        <label for="startDate">Fecha de Inicio *</label>
                        <input id="startDate" type="date">
                    </div>
                    <div style="flex:1;">
                        <label for="endDate">Fecha de Fin *</label>
                        <input id="endDate" type="date">
                    </div>
                </div>

                <label for="reason">Raz√≥n de la Ausencia</label>
                <input id="reason" type="text" placeholder="Ej: Vacaciones, d√≠a libre, etc. (Opcional)">

                <button class="primary" id="btnSaveAbsence">Guardar Periodo de Ausencia por D√≠as</button>
            </div>
            
            <div class="card">
                <h3>‚è∞ Marcar Ausencia Temporal (Por Horas)</h3>
                <div id="hourlyAbsenceMessage" class="message"></div>

                <label for="hourlyDate">Fecha de Ausencia *</label>
                <input id="hourlyDate" type="date">

                <div class="row">
                    <div style="flex:1;">
                        <label for="startTime">Hora de Inicio *</label>
                        <input id="startTime" type="time">
                    </div>
                    <div style="flex:1;">
                        <label for="endTime">Hora de Fin *</label>
                        <input id="endTime" type="time">
                    </div>
                </div>

                <label for="hourlyReason">Raz√≥n de la Ausencia</label>
                <input id="hourlyReason" type="text" placeholder="Ej: Cita m√©dica, almuerzo extendido, etc. (Opcional)">

                <button class="primary" id="btnSaveHourlyAbsence">Guardar Ausencia Temporal</button>
            </div>
            <div class="card">
                <h3>üìÖ Ausencias Programadas (D√≠as y Horas)</h3>
                <div id="absenceListContainer" class="list-container">
                    <p style="text-align:center; color:var(--muted);">Cargando ausencias...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase config (DEBE SER LA MISMA que en el index (2).html)
        const firebaseConfig = {
          apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
          authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
          databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
          projectId: "lazonadelbarbero-b4e75",
          storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
          messagingSenderId: "251180096928",
          appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
          measurementId: "G-G4YL7M4Z00"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ** Hardcoded Credentials (ACTUALIZADAS) **
        const BARBER_CREDENTIALS = {
            "dilan_admin": { password: "Dilan123", name: "Dilan" },
            "alejo_admin": { password: "Alejo123", name: "Alejandro" },
            "leo_admin": { password: "Leo123", name: "Leonardo" },
            "santi_admin": { password: "Santi123", name: "Santiago" }
        };
        
        let LOGGED_IN_BARBER = localStorage.getItem('loggedBarber') || null;

        // Almacenamiento global para el estado
        let allAppointmentsCache = [];
        // NEW: Almacenar√° { barbero: { days: { YYYY-MM-DD: {...} }, hours: { YYYY-MM-DD: { minutes: {...} } } } }
        let allAbsencesCache = {}; 
        let currentAppointmentCount = 0;
        const notificationSound = new Audio('https://s3-us-west-2.amazonaws.com/s.cdpn.io/12028/notification.mp3'); 

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const barberNameDisplay = document.getElementById('barberNameDisplay');
        const appointmentList = document.getElementById('appointmentList');
        const appointmentCount = document.getElementById('appointmentCount');

        // Login DOM
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const btnLogin = document.getElementById('btnLogin');
        const loginMessageEl = document.getElementById('loginMessage');
        const btnLogout = document.getElementById('btnLogout');

        // Absence DOM (D√≠as Completos)
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const reasonEl = document.getElementById('reason');
        const btnSaveAbsence = document.getElementById('btnSaveAbsence');
        const absenceMessageEl = document.getElementById('absenceMessage');
        const absenceListContainer = document.getElementById('absenceListContainer');
        
        // NEW: Absence DOM (Por Horas)
        const hourlyDateEl = document.getElementById('hourlyDate');
        const startTimeEl = document.getElementById('startTime');
        const endTimeEl = document.getElementById('endTime');
        const hourlyReasonEl = document.getElementById('hourlyReason');
        const btnSaveHourlyAbsence = document.getElementById('btnSaveHourlyAbsence');
        const hourlyAbsenceMessageEl = document.getElementById('hourlyAbsenceMessage');
        
        // Filter DOM
        const filterDateEl = document.getElementById('filterDate');
        const clearDateFilterBtn = document.getElementById('clearDateFilter');
        
        // Notification DOM
        const notificationBanner = document.getElementById('notificationBanner');


        // --- UTILS ---
        function minutesToAmPmWithSpace(m){
            let hh = Math.floor(m/60); const mm = String(m%60).padStart(2,'0');
            const ampm = hh >= 12 ? 'PM' : 'AM'; hh = hh % 12; if(hh===0) hh=12;
            return `${hh}:${mm} ${ampm}`;
        }
        function formatFirebaseDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('es-CO', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace('.', '');
        }
        // Convierte "HH:MM" a minutos desde la medianoche
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // --- NEW: L√ìGICA DE DETECCI√ìN DE AUSENCIA EN CITA (USA allAbsencesCache) ---
        function checkAppointmentAbsence(dateISO, startMinutes, endMinutes) {
            const absences = allAbsencesCache[LOGGED_IN_BARBER] || {};
            const dayAbsences = absences.days || {};
            const hourAbsences = absences.hours || {};
            const today = new Date().toISOString().split('T')[0];
            
            // 1. Verificar Ausencia por D√≠as Completos (Rango)
            for (const startDate in dayAbsences) {
                const period = dayAbsences[startDate];
                if (period.endDate >= today && dateISO >= startDate && dateISO <= period.endDate) {
                    return { isAbsent: true, reason: period.reason || 'Ausencia de d√≠a completo' };
                }
            }
            
            // 2. Verificar Ausencia por Horas (Solo en la fecha de la cita)
            const hourlyAbsencesOnDate = hourAbsences[dateISO];
            if (hourlyAbsencesOnDate) {
                for (const startMinKey in hourlyAbsencesOnDate) {
                    const period = hourlyAbsencesOnDate[startMinKey];
                    const absenceStart = Number(startMinKey);
                    const absenceEnd = Number(period.endMinutes);
                    
                    const isFutureOrPresent = dateISO > today || (dateISO === today && absenceEnd > (new Date().getHours() * 60 + new Date().getMinutes()));

                    // Conflicto: [startMinutes, endMinutes] se solapa con [absenceStart, absenceEnd]
                    if (isFutureOrPresent && (startMinutes < absenceEnd && endMinutes > absenceStart) ) {
                        return { isAbsent: true, reason: period.reason || 'Bloqueo temporal por horas' };
                    }
                }
            }
            
            return { isAbsent: false, reason: 'Presente' };
        }
        
        // Helper para procesar la data de Firebase en un array ordenado
        function processSnapshot(snapshot) {
            const allAppointments = [];
            if (snapshot.exists()) {
                const datesData = snapshot.val();
                for (const dateISO in datesData) {
                    const appointmentsOnDate = datesData[dateISO];
                    for (const key in appointmentsOnDate) {
                        const appt = appointmentsOnDate[key];
                        // Solo procesar citas para el barbero logueado (aunque ya se filtra por ruta)
                        if (appt.barbero === LOGGED_IN_BARBER) { 
                            appt.dateISO = dateISO;
                            appt.id = key; 
                            appt.startMinutes = Number(appt.startMinutes);
                            appt.endMinutes = Number(appt.endMinutes || (appt.startMinutes + appt.durationMinutes));
                            appt.completed = appt.completed || false; 
                            // NEW: Verificar si la cita cae en un periodo de ausencia del barbero
                            appt.absenceStatus = checkAppointmentAbsence(dateISO, appt.startMinutes, appt.endMinutes);
                            allAppointments.push(appt);
                        }
                    }
                }
            }
            // Sort by date (oldest first) and then by start time
            allAppointments.sort((a, b) => {
                if (a.dateISO > b.dateISO) return 1;
                if (a.dateISO < b.dateISO) return -1;
                return a.startMinutes - b.startMinutes;
            });
            return allAppointments;
        }


        // --- MESSAGE HANDLERS ---
        function showMessage(element, type, text) {
            element.classList.remove('success', 'error');
            element.classList.add(type);
            element.textContent = text;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }
        
        // --- Solicitar permiso de notificaci√≥n ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Este navegador no soporta notificaciones de escritorio.");
            } else if (Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log("Permiso de notificaci√≥n concedido.");
                    } else {
                        console.log("Permiso de notificaci√≥n denegado.");
                    }
                });
            }
        }


        // --- AUTHENTICATION LOGIC ---
        function checkLoginState() {
            if (LOGGED_IN_BARBER) {
                barberNameDisplay.textContent = LOGGED_IN_BARBER;
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                loadDashboardData(LOGGED_IN_BARBER);

                // Configurar listeners de filtro para que trabajen con la cach√©
                filterDateEl.addEventListener('change', () => refreshAppointmentDisplay(LOGGED_IN_BARBER));
                clearDateFilterBtn.addEventListener('click', () => {
                    filterDateEl.value = '';
                    refreshAppointmentDisplay(LOGGED_IN_BARBER);
                });
            } else {
                loginContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                usernameEl.value = '';
                passwordEl.value = '';
                filterDateEl.value = ''; // Limpiar filtro al cerrar sesi√≥n
                appointmentList.innerHTML = '';
                usernameEl.focus();
            }
        }

        btnLogin.addEventListener('click', () => {
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            
            const user = BARBER_CREDENTIALS[username];
            
            if(user && user.password === password) {
                LOGGED_IN_BARBER = user.name;
                localStorage.setItem('loggedBarber', LOGGED_IN_BARBER);
                showMessage(loginMessageEl, 'success', `Bienvenido, ${LOGGED_IN_BARBER}.`);
                requestNotificationPermission(); 
                checkLoginState();
            } else {
                showMessage(loginMessageEl, 'error', 'Usuario o contrase√±a incorrectos.');
            }
        });

        btnLogout.addEventListener('click', () => {
            LOGGED_IN_BARBER = null;
            localStorage.removeItem('loggedBarber');
            showMessage(loginMessageEl, 'success', 'Sesi√≥n cerrada. Vuelve pronto.');
            checkLoginState();
        });
        
        // --- DASHBOARD DATA LOADING ---

        function loadDashboardData(barbero) {
            setupAbsenceListener(barbero); 
            setupAppointmentListener(barbero); 
        }

        // --- ABSENCE LISTENER (Real-time updates) ---
        function setupAbsenceListener(barbero) {
            const absencesRef = ref(db, `unavailableDates/${barbero}`);
            onValue(absencesRef, (snapshot) => {
                // Almacena solo la data del barbero logueado para la cach√© global
                allAbsencesCache[barbero] = snapshot.val() || { days: {}, hours: {} };
                
                // Una vez que se actualiza la cach√© de ausencias, se refrescan ambos
                displayAbsences(barbero);
                refreshAppointmentDisplay(barbero); 
            });
        }


        // --- APPOINTMENT LISTENER LOGIC (Real-time updates) ---

        function setupAppointmentListener(barbero) {
            const appointmentsRef = ref(db, `appointments`); // Escucha todo, filtra por barbero en processSnapshot
            
            let initialLoad = true;
            
            // onValue escucha cambios en tiempo real
            onValue(appointmentsRef, (snapshot) => {
                const newAppointmentsData = processSnapshot(snapshot).filter(a => a.barbero === barbero);
                
                // 1. Check for new appointments 
                if (!initialLoad) {
                    const currentActive = allAppointmentsCache.filter(a => !a.completed).length;
                    const newActive = newAppointmentsData.filter(a => !a.completed).length;
                    
                    if (newActive > currentActive) {
                       triggerNewAppointmentNotification(newAppointmentsData);
                    }
                }
                
                // 2. Update global state
                allAppointmentsCache = newAppointmentsData;
                currentAppointmentCount = newAppointmentsData.length;

                // 3. Refresh display with the new data (and apply current filter)
                refreshAppointmentDisplay(barbero);
                initialLoad = false;
            });
        }
        
        function triggerNewAppointmentNotification(newAppointmentsData) {
            // Encontrar la √∫ltima cita a√±adida comparando con la cach√© antigua
            const oldIds = new Set(allAppointmentsCache.map(a => `${a.dateISO}-${a.id}`));
            const latest = newAppointmentsData.find(appt => !oldIds.has(`${appt.dateISO}-${appt.id}`));
            
            const clientName = latest ? latest.nombre : 'Cliente Desconocido';
            const clientTime = latest ? minutesToAmPmWithSpace(latest.startMinutes) : 'N/A';
            
            if (!latest) return;
            
            // --- 1. WEB PUSH NOTIFICATION (OS-style) ---
            if (Notification.permission === 'granted') {
                new Notification('üö® ¬°NUEVA CITA AGENDADA!', {
                    body: `Cliente: ${clientName} - Hora: ${clientTime} - Barbero: ${LOGGED_IN_BARBER}`,
                    icon: '1000070893.png', 
                    vibrate: [200, 100, 200]
                });
            }
            
            // --- 2. IN-APP BANNER (Sonido y alerta dentro de la p√°gina) ---
            if(document.visibilityState === 'visible') {
                notificationSound.play().catch(e => console.log('Error playing sound:', e));
            }

            notificationBanner.textContent = `üîî ¬°NUEVA CITA AGENDADA! Cliente: ${clientName} - Hora: ${clientTime}`;
            notificationBanner.classList.add('success');
            notificationBanner.style.display = 'block';
            
            // Ocultar despu√©s de 7 segundos
            setTimeout(() => {
                notificationBanner.style.display = 'none';
            }, 7000);
        }

        // --- APPOINTMENT LIST DISPLAY (Modified to use cache and check absence) ---
        function refreshAppointmentDisplay(barbero) {
            const allAppointments = allAppointmentsCache;
            const filterDate = filterDateEl.value; 
            let filteredAppointments = allAppointments;

            if (filterDate) {
                filteredAppointments = allAppointments.filter(appt => appt.dateISO === filterDate);
            }

            appointmentCount.textContent = `(${filteredAppointments.length} Citas)`;

            if (filteredAppointments.length === 0) {
                appointmentList.innerHTML = `<p style="text-align:center; color:var(--muted);">No hay citas agendadas ${filterDate ? 'para la fecha seleccionada' : ''} para ti, ${barbero}.</p>`;
                return;
            }

            let tableHTML = `
                <table class="appointment-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Tel√©fono</th>
                            <th>Servicio</th>
                            <th>Fecha y Hora</th>
                            <th>Asistencia y Raz√≥n</th>
                            <th>Creada</th>
                            <th>Acciones</th> 
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredAppointments.forEach(appt => {
                const horaNice = minutesToAmPmWithSpace(appt.startMinutes);
                
                const todayISO = new Date().toISOString().split('T')[0];
                const nowMinutes = new Date().getHours() * 60 + new Date().getMinutes();
                
                const isPast = appt.dateISO < todayISO || (appt.dateISO === todayISO && appt.endMinutes < nowMinutes);
                const isCompleted = appt.completed === true;

                // ** L√≥gica de Ausencia y Asistencia **
                let statusPill = '';
                let statusReason = '';
                
                // 1. Verificar Ausencia del Barbero
                const absenceCheck = checkAppointmentAbsence(appt.dateISO, appt.startMinutes, appt.endMinutes);

                if (absenceCheck.isAbsent) {
                    statusPill = `<span class="status-pill status-absent">üö´ AUSENTE</span>`;
                    statusReason = absenceCheck.reason;
                } else if (isCompleted) {
                    // 2. Verificar Cita Completada
                    statusPill = `<span class="status-pill status-good">‚úÖ REALIZADA</span>`;
                    statusReason = 'Cita completada con √©xito';
                } else if (isPast) {
                    // 3. Citas Pasadas No Completadas (Se asume Inasistencia/Pendiente)
                    statusPill = `<span class="status-pill status-warning">‚ö†Ô∏è PASADA</span>`;
                    statusReason = 'No marcada como realizada';
                } else {
                    // 4. Citas Pendientes (Barbero Presente)
                    statusPill = `<span class="status-pill status-present">üü¢ ACTIVA</span>`;
                    statusReason = 'Barbero presente, pendiente de realizar';
                }


                let rowClasses = '';
                let textClasses = '';
                if (isCompleted) {
                    rowClasses = 'completed-row';
                    textClasses = 'completed-text';
                } else if (isPast && !isCompleted) {
                    textClasses = 'completed-text'; // Usar solo tachado para pasado no completado
                }

                const fullName = appt.nombre || 'N/A';
                const nameParts = fullName.split(' ');
                const firstName = nameParts[0];
                const lastName = nameParts.slice(1).join(' ');

                tableHTML += `
                    <tr class="${rowClasses}">
                        <td class="${textClasses}">${firstName} <br><strong>${lastName}</strong></td>
                        <td class="${textClasses}">
                            <a href="https://wa.me/57${appt.telefono.replace(/\D/g,'')}" target="_blank" class="phone-link" style="${isCompleted || isPast ? 'opacity: 0.8;' : ''}">
                                ${appt.telefono} üì≤
                            </a>
                        </td>
                        <td class="${textClasses}">${appt.servicio} (${appt.durationMinutes}m)</td>
                        <td class="${textClasses}">
                            ${appt.dateISO} 
                            <br>
                            <strong>${horaNice}</strong>
                        </td>
                        <td>
                            ${statusPill}
                            <br>
                            <span style="font-size:10px; color:var(--muted);">${statusReason}</span>
                        </td>
                        <td class="${textClasses}"><span class="date-created">${formatFirebaseDate(appt.createdAt)}</span></td>
                        <td class="action-col">
                            ${!isCompleted ? `
                                <button class="action-btn complete-btn" 
                                    data-barbero="${barbero}" 
                                    data-date="${appt.dateISO}" 
                                    data-appt-id="${appt.id}" 
                                    title="Marcar como realizada">
                                    ‚úÖ Realizada
                                </button>
                            ` : ''}
                            <button class="action-btn delete-btn" 
                                data-barbero="${barbero}" 
                                data-date="${appt.dateISO}" 
                                data-appt-id="${appt.id}" 
                                title="Eliminar la cita">
                                üóëÔ∏è Eliminar
                            </button>
                            <a href="https://wa.me/57${appt.telefono.replace(/\D/g,'')}" target="_blank" class="action-btn edit-btn" title="Contactar al cliente para editar/reagendar">
                                ‚úèÔ∏è Editar
                            </a>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            appointmentList.innerHTML = tableHTML;
            
            // Re-attach listeners
            appointmentList.querySelectorAll('.delete-btn').forEach(button => {
                button.removeEventListener('click', handleDeleteAppointment); 
                button.addEventListener('click', handleDeleteAppointment);
            });
            
            appointmentList.querySelectorAll('.complete-btn').forEach(button => {
                button.removeEventListener('click', handleCompleteAppointment); 
                button.addEventListener('click', handleCompleteAppointment);
            });
            
        }


        // --- DELETE APPOINTMENT LOGIC ---
        async function handleDeleteAppointment(event) {
            if(!confirm('¬øEst√°s seguro de que quieres ELIMINAR esta cita? Esta acci√≥n es irreversible.')) return;
            
            const button = event.target;
            const barbero = button.dataset.barbero;
            const dateISO = button.dataset.date;
            const appointmentId = button.dataset.apptId; 

            if(!barbero || !dateISO || !appointmentId) {
                showMessage(loginMessageEl, 'error', 'Error interno: Faltan datos de la cita.');
                return;
            }
            
            button.disabled = true;
            button.textContent = '...';

            try {
                const path = `appointments/${barbero}/${dateISO}/${appointmentId}`;
                await remove(ref(db, path));
                
                showMessage(loginMessageEl, 'success', `Cita del ${dateISO} eliminada correctamente.`);
                
            } catch(error) {
                console.error("Error deleting appointment:", error);
                showMessage(loginMessageEl, 'error', 'Error al eliminar la cita. Revisa la consola.');
            }
        }
        
        // COMPLETE APPOINTMENT LOGIC
        async function handleCompleteAppointment(event) {
            if(!confirm('¬øMarcar esta cita como REALIZADA con √©xito?')) return;
            
            const button = event.target;
            const barbero = button.dataset.barbero;
            const dateISO = button.dataset.date;
            const appointmentId = button.dataset.apptId; 

            if(!barbero || !dateISO || !appointmentId) {
                showMessage(loginMessageEl, 'error', 'Error interno: Faltan datos de la cita.');
                return;
            }
            
            button.disabled = true;
            button.textContent = '...';

            try {
                const path = `appointments/${barbero}/${dateISO}/${appointmentId}/completed`;
                await set(ref(db, path), true);
                
                showMessage(loginMessageEl, 'success', `Cita del ${dateISO} marcada como Realizada.`);
                
            } catch(error) {
                console.error("Error completing appointment:", error);
                showMessage(loginMessageEl, 'error', 'Error al marcar la cita como realizada.');
            }
        }


        // --- ABSENCE LOGIC (MODIFICADO) ---

        async function displayAbsences(barbero) {
            absenceListContainer.innerHTML = '<p style="text-align:center;"><span class="loader"></span> Cargando...</p>';
            
            const absences = allAbsencesCache[barbero] || {};
            const dayAbsences = absences.days || {};
            const hourAbsences = absences.hours || {};
            
            const allAbsences = [];
            const today = new Date().toISOString().split('T')[0];
            const nowMinutes = new Date().getHours() * 60 + new Date().getMinutes();


            // 1. D√≠as Completos
            for (const startDate in dayAbsences) {
                const period = dayAbsences[startDate];
                const isPast = period.endDate < today;
                allAbsences.push({
                    type: 'day',
                    startDate: startDate,
                    endDate: period.endDate,
                    reason: period.reason,
                    isPast: isPast,
                    sortKey: startDate // Clave de ordenaci√≥n
                });
            }
            
            // 2. Ausencias por Horas
            for (const date in hourAbsences) {
                const periods = hourAbsences[date];
                for (const startMinutes in periods) {
                    const period = periods[startMinutes];
                    
                    const isPast = date < today || (date === today && period.endMinutes < nowMinutes);
                    
                    allAbsences.push({
                        type: 'hour',
                        date: date,
                        startMinutes: Number(startMinutes),
                        endMinutes: Number(period.endMinutes),
                        reason: period.reason,
                        isPast: isPast,
                        sortKey: `${date}-${String(startMinutes).padStart(4, '0')}` // Clave de ordenaci√≥n
                    });
                }
            }
            
            allAbsences.sort((a, b) => a.sortKey.localeCompare(b.sortKey));


            if(allAbsences.length === 0) {
                absenceListContainer.innerHTML = `<p style="text-align:center; color:var(--muted);">No tienes ausencias programadas para ti.</p>`;
                return;
            }

            let html = '';
            
            allAbsences.forEach(abs => {
                const style = abs.isPast ? 'opacity: 0.6; text-decoration: line-through;' : '';
                let content;
                let deleteBtn;
                
                if (abs.type === 'day') {
                    content = `
                        <strong>D√çA: ${abs.startDate}</strong> al <strong>${abs.endDate}</strong> 
                        <span style="color:var(--accent); margin-left: 8px;">(${abs.reason})</span>
                        ${abs.isPast ? '<span style="color:var(--danger); font-size:11px;">(Pasado)</span>' : ''}
                    `;
                    deleteBtn = `
                        <button class="delete-btn absence" 
                            data-barbero="${barbero}" 
                            data-type="day"
                            data-startdate="${abs.startDate}">Eliminar</button>
                    `;
                } else { // type === 'hour'
                    content = `
                        ‚è∞ **HORAS: ${abs.date}** de **${minutesToAmPmWithSpace(abs.startMinutes)}** a **${minutesToAmPmWithSpace(abs.endMinutes)}** <span style="color:var(--accent-2); margin-left: 8px;">(${abs.reason})</span>
                        ${abs.isPast ? '<span style="color:var(--danger); font-size:11px;">(Pasado)</span>' : ''}
                    `;
                    deleteBtn = `
                        <button class="delete-btn absence" 
                            data-barbero="${barbero}" 
                            data-type="hour"
                            data-date="${abs.date}"
                            data-startminutes="${abs.startMinutes}">Eliminar</button>
                    `;
                }
                
                html += `
                    <div class="period-item" style="${style}">
                        <div>${content}</div>
                        ${!abs.isPast ? deleteBtn : ''}
                    </div>
                `;
            });
            
            absenceListContainer.innerHTML = html;
            
            absenceListContainer.querySelectorAll('.delete-btn.absence').forEach(button => {
                button.removeEventListener('click', handleDeleteAbsence); 
                button.addEventListener('click', handleDeleteAbsence);
            });

        }
        
        // L√≥gica de D√≠as Completos 
        btnSaveAbsence.addEventListener('click', async () => {
            const barbero = LOGGED_IN_BARBER; 
            const startDate = startDateEl.value;
            const endDate = endDateEl.value;
            const reason = reasonEl.value.trim();
            
            if(!barbero || !startDate || !endDate){
                showMessage(absenceMessageEl, 'error', 'Por favor, selecciona la fecha de inicio y fecha de fin.');
                return;
            }

            if(startDate > endDate){
                showMessage(absenceMessageEl, 'error', 'La fecha de inicio no puede ser posterior a la fecha de fin.');
                return;
            }
            
            btnSaveAbsence.disabled = true;
            btnSaveAbsence.innerHTML = 'Guardando... <span class="loader"></span>';

            try {
                // Path: unavailableDates/{barbero}/days/{startDate}
                const path = `unavailableDates/${barbero}/days/${startDate}`; 
                const data = {
                    endDate: endDate,
                    reason: reason || 'Ausencia de d√≠a completo'
                };

                await set(ref(db, path), data);
                
                showMessage(absenceMessageEl, 'success', `Ausencia de d√≠as guardada correctamente del ${startDate} al ${endDate}.`);
                
                startDateEl.value = '';
                endDateEl.value = '';
                reasonEl.value = '';
                
            } catch(error) {
                console.error("Error saving day absence:", error);
                showMessage(absenceMessageEl, 'error', 'Error al guardar la ausencia. Revisa la consola.');
            } finally {
                btnSaveAbsence.disabled = false;
                btnSaveAbsence.textContent = 'Guardar Periodo de Ausencia por D√≠as';
            }
        });
        
        // L√≥gica de Ausencias por Horas
        btnSaveHourlyAbsence.addEventListener('click', async () => {
            const barbero = LOGGED_IN_BARBER; 
            const date = hourlyDateEl.value;
            const startTimeStr = startTimeEl.value;
            const endTimeStr = endTimeEl.value;
            const reason = hourlyReasonEl.value.trim();
            
            if(!barbero || !date || !startTimeStr || !endTimeStr){
                showMessage(hourlyAbsenceMessageEl, 'error', 'Por favor, selecciona la fecha, hora de inicio y hora de fin.');
                return;
            }
            
            const startMinutes = timeToMinutes(startTimeStr);
            const endMinutes = timeToMinutes(endTimeStr);

            if(startMinutes >= endMinutes){
                showMessage(hourlyAbsenceMessageEl, 'error', 'La hora de inicio debe ser anterior a la hora de fin.');
                return;
            }
            
            btnSaveHourlyAbsence.disabled = true;
            btnSaveHourlyAbsence.innerHTML = 'Guardando... <span class="loader"></span>';

            try {
                // Path: unavailableDates/{barbero}/hours/{date}/{startMinutes}
                const path = `unavailableDates/${barbero}/hours/${date}/${startMinutes}`;
                const data = {
                    endMinutes: endMinutes,
                    reason: reason || 'Ausencia temporal por horas'
                };

                await set(ref(db, path), data);
                
                showMessage(hourlyAbsenceMessageEl, 'success', `Ausencia por horas guardada para el ${date} de ${startTimeStr} a ${endTimeStr}.`);
                
                hourlyDateEl.value = '';
                startTimeEl.value = '';
                endTimeEl.value = '';
                hourlyReasonEl.value = '';
                
            } catch(error) {
                console.error("Error saving hourly absence:", error);
                showMessage(hourlyAbsenceMessageEl, 'error', 'Error al guardar la ausencia por horas. Revisa la consola.');
            } finally {
                btnSaveHourlyAbsence.disabled = false;
                btnSaveHourlyAbsence.textContent = 'Guardar Ausencia Temporal';
            }
        });


        async function handleDeleteAbsence(event) {
            if(!confirm('¬øEst√°s seguro de que quieres eliminar este periodo de ausencia?')) return;
            
            const button = event.target;
            const barbero = button.dataset.barbero;
            const type = button.dataset.type; // 'day' o 'hour'
            
            button.disabled = true;
            button.textContent = '...';

            let path;
            if (type === 'day') {
                const startDate = button.dataset.startdate;
                path = `unavailableDates/${barbero}/days/${startDate}`;
            } else if (type === 'hour') {
                const date = button.dataset.date;
                const startMinutes = button.dataset.startminutes;
                path = `unavailableDates/${barbero}/hours/${date}/${startMinutes}`;
            } else {
                showMessage(absenceMessageEl, 'error', 'Error interno: Tipo de ausencia desconocido.');
                button.disabled = false;
                button.textContent = 'Eliminar';
                return;
            }

            try {
                await remove(ref(db, path));
                showMessage(absenceMessageEl, 'success', `Ausencia eliminada correctamente.`);
            } catch(error) {
                console.error("Error deleting absence:", error);
                showMessage(absenceMessageEl, 'error', 'Error al eliminar la ausencia.');
            } finally {
                if(button.textContent === '...') {
                    button.disabled = false;
                    button.textContent = 'Eliminar';
                }
            }
        }

        // Inicializaci√≥n
        checkLoginState();
    </script>
</body>
</html>
