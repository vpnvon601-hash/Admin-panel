<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LA ZONA DEL BARBERO â€” Panel Admin</title>
    <style>
        /* Estilos base (copiados para consistencia) */
        :root{
            --bg:#06070a; --card:#0e1115; --muted:#9aa0a6; --line:#1e252b;
            --text:#e6eef3; --accent:#f6c358; --accent-2:#7be3a8; --glass:rgba(255,255,255,0.03);
            --danger:#ef6b6b; --good:#35d19b;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#030304 0%,#071018 100%);color:var(--text);-webkit-font-smoothing:antialiased; padding:20px;}
        .container{max-width:900px;margin:auto;}
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:var(--radius);border:1px solid var(--line);box-shadow:0 6px 30px rgba(0,0,0,0.6); margin-bottom: 20px;}
        h2{color:var(--accent); text-align:center;}
        h3{margin:0 0 12px 0;font-weight:700}
        label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px; margin-top: 10px;}
        input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);font-size:15px}
        button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#071018;border:none;padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 8px 20px rgba(123,227,168,0.06); width: 100%; margin-top: 20px;}
        button.secondary{background:transparent;color:var(--text);border:1px solid var(--line);padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700; width: 100%; margin-top: 10px;}
        .row{display:flex;gap:10px;}
        .message{padding:10px;border-radius:10px;margin-top:10px;font-size:14px; display:none; margin-bottom: 10px;} /* margin-bottom agregado */
        .success{background:rgba(53, 209, 155, 0.1); color:var(--good); border:1px solid var(--good);}
        .error{background:rgba(239, 107, 107, 0.1); color:var(--danger); border:1px solid var(--danger);}
        .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid var(--line);border-top-color:var(--accent);animation:spin .9s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Estilos de lista de citas */
        .appointment-table-container{overflow-x:auto;}
        .appointment-table{width:100%; border-collapse: collapse; margin-top:15px;}
        .appointment-table th, .appointment-table td{padding:10px 12px; text-align: left; border-bottom:1px solid var(--line); font-size:14px;}
        .appointment-table th{background:rgba(255,255,255,0.03); font-weight:700; color:var(--accent-2);}
        .appointment-table tr:hover{background:rgba(255,255,255,0.01);}
        .appointment-table .phone-link{white-space:nowrap; color:var(--accent); text-decoration:none; font-weight: 600;}
        .appointment-table .date-created{font-size:10px; color:var(--muted); white-space:nowrap;}
        .appointment-table td.action-col { width: 1%; white-space: nowrap; }
        .action-btn{ padding:6px 10px; font-size:12px; margin:2px; display:inline-block; border-radius:6px; cursor:pointer;}
        .delete-btn{ background:var(--danger); color:white; border:none; }
        .edit-btn{ background:var(--muted); color:#071018; border:none; }
        
        /* Ausencias */
        .list-container{border:1px solid var(--line); border-radius:var(--radius); padding:10px; max-height: 250px; overflow-y: auto; margin-top:10px;}
        .period-item{padding:8px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
        .period-item:last-child{border-bottom:none;}
        .delete-btn.absence{background:var(--danger); color:white; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; font-size:12px;}

        /* Header */
        header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding:10px 0; border-bottom: 1px solid var(--line);}
        header h3{margin:0; color:var(--accent-2);}
        .user-info{font-size:14px; color:var(--muted);}
        .logout-btn{padding:8px 12px; font-size:14px; cursor:pointer;}

        /* ADDED: Logo Image Container */
        .logo-container{
            width:40px;height:40px;border-radius:50%;
            background:linear-gradient(135deg,var(--accent),var(--accent-2));
            display:inline-grid;place-items:center;
            box-shadow: 0 0 10px rgba(246, 195, 88, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display:flex;align-items:center;gap:12px;justify-content:center;font-weight:800;font-size:20px; margin-bottom: 20px;">
            <div class="logo-container">
                 <img src="1000070893.png" alt="Logo La Zona del Barbero" style="width:100%;height:100%;object-fit:cover;border-radius:50%">
            </div>
            <h2 style="margin:0;">Panel de AdministraciÃ³n â€” LA ZONA DEL BARBERO</h2>
        </div>
        <div id="loginContainer" class="card" style="max-width:400px; margin: 40px auto;">
            <h3>ðŸ”‘ Iniciar SesiÃ³n</h3>
            <div id="loginMessage" class="message"></div>
            
            <label for="username">Usuario</label>
            <input id="username" type="text" placeholder="Tu usuario">

            <label for="password">ContraseÃ±a</label>
            <input id="password" type="password" placeholder="Tu contraseÃ±a">

            <button class="primary" id="btnLogin">Acceder al Panel</button>
            <p style="text-align:center; font-size:12px; color:var(--muted); margin-top:15px;">**Usuarios de Prueba:**<br>Dilan: dilan_admin / Dilan123</p>
        </div>

        <div id="dashboardContainer" style="display:none;">
            <header>
                <div class="user-info">SesiÃ³n iniciada como: <strong id="barberNameDisplay"></strong></div>
                <button id="btnLogout" class="secondary logout-btn">Cerrar SesiÃ³n</button>
            </header>
            
            <div id="notificationBanner" class="message success" style="display: none; font-weight: 700;"></div>

            <div class="card">
                <h3 style="display:flex; justify-content:space-between; align-items:center;">
                    ðŸ“… Tus Citas Agendadas
                    <span id="appointmentCount" style="font-size:14px; color:var(--accent);"></span>
                </h3>

                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <label for="filterDate">Buscar/Filtrar por Fecha:</label>
                        <input id="filterDate" type="date">
                    </div>
                    <button id="clearDateFilter" class="secondary" style="width:auto; padding:12px 14px; margin:0;">Mostrar Todo</button>
                </div>
                
                <div id="appointmentList" class="appointment-table-container">
                    <p style="text-align:center; color:var(--muted);">Cargando citas...</p>
                </div>
            </div>

            <div class="card">
                <h3>â›” Marcar Ausencia Personal</h3>
                <div id="absenceMessage" class="message"></div>

                <div class="row">
                    <div style="flex:1;">
                        <label for="startDate">Fecha de Inicio *</label>
                        <input id="startDate" type="date">
                    </div>
                    <div style="flex:1;">
                        <label for="endDate">Fecha de Fin *</label>
                        <input id="endDate" type="date">
                    </div>
                </div>

                <label for="reason">RazÃ³n de la Ausencia</label>
                <input id="reason" type="text" placeholder="Ej: Vacaciones, dÃ­a libre, etc. (Opcional)">

                <button class="primary" id="btnSaveAbsence">Guardar Periodo de Ausencia</button>
            </div>

            <div class="card">
                <h3>ðŸ“… Ausencias Programadas (Tus Ausencias)</h3>
                <div id="absenceListContainer" class="list-container">
                    <p style="text-align:center; color:var(--muted);">Cargando ausencias...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        // Importamos 'set' para guardar, 'get' para leer, 'remove' para eliminar y 'onValue' para escuchar cambios
        import { getDatabase, ref, set, get, child, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase config (DEBE SER LA MISMA que en el index (2).html)
        const firebaseConfig = {
          apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
          authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
          databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
          projectId: "lazonadelbarbero-b4e75",
          storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
          messagingSenderId: "251180096928",
          appId: "1:251180096928:web:86d0ab83c7e444af79d8c5",
          measurementId: "G-G4YL7M4Z00"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ** Hardcoded Credentials **
        const BARBER_CREDENTIALS = {
            "dilan_admin": { password: "Dilan123", name: "Dilan" },
            "alejo_admin": { password: "Alejo123", name: "Alejandro" },
            "leo_admin": { password: "Leo123", name: "Leonardo" },
            "santi_admin": { password: "Santi1011", name: "Santiago" }
        };
        
        let LOGGED_IN_BARBER = localStorage.getItem('loggedBarber') || null;

        // NEW: Almacenamiento global para el estado y NotificaciÃ³n
        let allAppointmentsCache = [];
        let currentAppointmentCount = 0;
        // Sonido de notificaciÃ³n solo para la alerta in-app (si estÃ¡ visible)
        const notificationSound = new Audio('https://s3-us-west-2.amazonaws.com/s.cdpn.io/12028/notification.mp3'); 

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const barberNameDisplay = document.getElementById('barberNameDisplay');
        const appointmentList = document.getElementById('appointmentList');
        const appointmentCount = document.getElementById('appointmentCount');

        // Login DOM
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const btnLogin = document.getElementById('btnLogin');
        const loginMessageEl = document.getElementById('loginMessage');
        const btnLogout = document.getElementById('btnLogout');

        // Absence DOM
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const reasonEl = document.getElementById('reason');
        const btnSaveAbsence = document.getElementById('btnSaveAbsence');
        const absenceMessageEl = document.getElementById('absenceMessage');
        const absenceListContainer = document.getElementById('absenceListContainer');
        
        // Filter DOM
        const filterDateEl = document.getElementById('filterDate');
        const clearDateFilterBtn = document.getElementById('clearDateFilter');
        
        // NEW: Notification DOM
        const notificationBanner = document.getElementById('notificationBanner');


        // --- UTILS ---
        function minutesToAmPmWithSpace(m){
            let hh = Math.floor(m/60); const mm = String(m%60).padStart(2,'0');
            const ampm = hh >= 12 ? 'PM' : 'AM'; hh = hh % 12; if(hh===0) hh=12;
            return `${hh}:${mm} ${ampm}`;
        }
        function formatFirebaseDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('es-CO', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace('.', '');
        }
        
        // Helper para procesar la data de Firebase en un array ordenado
        function processSnapshot(snapshot) {
            const allAppointments = [];
            if (snapshot.exists()) {
                const datesData = snapshot.val();
                for (const dateISO in datesData) {
                    const appointmentsOnDate = datesData[dateISO];
                    for (const key in appointmentsOnDate) {
                        const appt = appointmentsOnDate[key];
                        appt.dateISO = dateISO;
                        appt.id = key; 
                        appt.startMinutes = Number(appt.startMinutes);
                        appt.endMinutes = Number(appt.endMinutes || (appt.startMinutes + appt.durationMinutes));
                        allAppointments.push(appt);
                    }
                }
            }
            // Sort by date (oldest first) and then by start time
            allAppointments.sort((a, b) => {
                if (a.dateISO > b.dateISO) return 1;
                if (a.dateISO < b.dateISO) return -1;
                return a.startMinutes - b.startMinutes;
            });
            return allAppointments;
        }


        // --- MESSAGE HANDLERS ---
        function showMessage(element, type, text) {
            element.classList.remove('success', 'error');
            element.classList.add(type);
            element.textContent = text;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }
        
        // --- NEW: Solicitar permiso de notificaciÃ³n ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Este navegador no soporta notificaciones de escritorio.");
            } else if (Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log("Permiso de notificaciÃ³n concedido.");
                    } else {
                        console.log("Permiso de notificaciÃ³n denegado.");
                    }
                });
            }
        }


        // --- AUTHENTICATION LOGIC ---
        function checkLoginState() {
            if (LOGGED_IN_BARBER) {
                barberNameDisplay.textContent = LOGGED_IN_BARBER;
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                loadDashboardData(LOGGED_IN_BARBER);

                // Configurar listeners de filtro para que trabajen con la cachÃ©
                filterDateEl.addEventListener('change', () => refreshAppointmentDisplay(LOGGED_IN_BARBER));
                clearDateFilterBtn.addEventListener('click', () => {
                    filterDateEl.value = '';
                    refreshAppointmentDisplay(LOGGED_IN_BARBER);
                });
            } else {
                loginContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                usernameEl.value = '';
                passwordEl.value = '';
                filterDateEl.value = ''; // Limpiar filtro al cerrar sesiÃ³n
                appointmentList.innerHTML = '';
                usernameEl.focus();
            }
        }

        btnLogin.addEventListener('click', () => {
            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            
            const user = BARBER_CREDENTIALS[username];

            if(user && user.password === password) {
                LOGGED_IN_BARBER = user.name;
                localStorage.setItem('loggedBarber', LOGGED_IN_BARBER);
                showMessage(loginMessageEl, 'success', `Bienvenido, ${LOGGED_IN_BARBER}.`);
                requestNotificationPermission(); // <--- NEW: Pide permiso de notificaciÃ³n
                checkLoginState();
            } else {
                showMessage(loginMessageEl, 'error', 'Usuario o contraseÃ±a incorrectos.');
            }
        });

        btnLogout.addEventListener('click', () => {
            LOGGED_IN_BARBER = null;
            localStorage.removeItem('loggedBarber');
            showMessage(loginMessageEl, 'success', 'SesiÃ³n cerrada. Vuelve pronto.');
            checkLoginState();
        });
        
        // --- DASHBOARD DATA LOADING ---

        async function loadDashboardData(barbero) {
            await displayAbsences(barbero);
            setupAppointmentListener(barbero); // Inicializa el listener en tiempo real
        }

        // --- NEW: APPOINTMENT LISTENER LOGIC ---

        function setupAppointmentListener(barbero) {
            const appointmentsRef = ref(db, `appointments/${barbero}`);
            
            // onValue escucha cambios en tiempo real
            onValue(appointmentsRef, (snapshot) => {
                const newAppointmentsData = processSnapshot(snapshot);
                
                // 1. Check for new appointments 
                if (currentAppointmentCount > 0 && newAppointmentsData.length > currentAppointmentCount) {
                    triggerNewAppointmentNotification();
                }
                
                // 2. Update global state
                allAppointmentsCache = newAppointmentsData;
                currentAppointmentCount = newAppointmentsData.length;

                // 3. Refresh display with the new data (and apply current filter)
                refreshAppointmentDisplay(barbero);
            });
        }
        
        function triggerNewAppointmentNotification() {
            // Encontrar la Ãºltima cita aÃ±adida 
            const latest = allAppointmentsCache.reduce((latest, current) => {
                return (latest === null || current.createdAt > latest.createdAt) ? current : latest;
            }, null);
            
            const clientName = latest ? latest.nombre : 'Cliente Desconocido';
            const clientTime = latest ? minutesToAmPmWithSpace(latest.startMinutes) : 'N/A';

            
            // --- 1. WEB PUSH NOTIFICATION (OS-style) ---
            if (Notification.permission === 'granted') {
                new Notification('ðŸš¨ Â¡NUEVA CITA AGENDADA!', {
                    body: `Cliente: ${clientName} - Hora: ${clientTime} - Barbero: ${LOGGED_IN_BARBER}`,
                    icon: '1000070893.png', // Usamos el logo que subiste
                    vibrate: [200, 100, 200]
                });
            }
            
            // --- 2. IN-APP BANNER (Sonido y alerta dentro de la pÃ¡gina) ---
            if(document.visibilityState === 'visible') {
                notificationSound.play().catch(e => console.log('Error playing sound:', e));
            }

            notificationBanner.textContent = `ðŸ”” Â¡NUEVA CITA AGENDADA! Cliente: ${clientName} - Hora: ${clientTime}`;
            notificationBanner.classList.add('success');
            notificationBanner.style.display = 'block';
            
            // Ocultar despuÃ©s de 7 segundos
            setTimeout(() => {
                notificationBanner.style.display = 'none';
            }, 7000);
        }

        // --- APPOINTMENT LIST DISPLAY (Modified to use cache) ---
        function refreshAppointmentDisplay(b
