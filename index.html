<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LA ZONA DEL BARBERO — Panel Admin</title>
    <style>
        /* Estilos base (copiados para consistencia) */
        :root{
            --bg:#06070a; --card:#0e1115; --muted:#9aa0a6; --line:#1e252b;
            --text:#e6eef3; --accent:#f6c358; --accent-2:#7be3a8; --glass:rgba(255,255,255,0.03);
            --danger:#ef6b6b; --good:#35d19b;
            --radius:14px;
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#030304 0%,#071018 100%);color:var(--text);-webkit-font-smoothing:antialiased; padding:20px;}
        .container{max-width:900px;margin:auto;}
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:var(--radius);border:1px solid var(--line);margin-bottom:20px;}
        h1, h2{color:var(--accent); text-align:center; margin-top:0;}
        .input-group label{display:block;margin-bottom:8px;font-weight:600;}
        .input-group select, .input-group input[type="date"], .input-group input[type="time"], .input-group textarea{
            width:100%;padding:10px;border-radius:var(--radius);border:1px solid var(--line);
            background-color:var(--card);color:var(--text);margin-bottom:15px;
        }
        .btn{padding:10px 20px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:background-color 0.2s;}
        .btn-primary{background-color:var(--accent);color:var(--bg);}
        .btn-danger{background-color:var(--danger);color:var(--text);}
        .btn-danger:hover{background-color:#d45a5a;}

        .absences-list{list-style:none;padding:0;}
        .absences-list li{background-color:var(--card);padding:10px;border-radius:var(--radius);border:1px solid var(--line);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
        .message.success{background-color:var(--good);color:var(--bg);padding:10px;border-radius:var(--radius);margin-bottom:15px;text-align:center;}
        .message.error{background-color:var(--danger);color:var(--text);padding:10px;border-radius:var(--radius);margin-bottom:15px;text-align:center;}
        .small{font-size:12px; color: var(--muted); margin-top:-10px; margin-bottom:15px;}
        
        /* Estilos para el nuevo grupo de hora de inicio y fin */
        .time-group { display: flex; gap: 10px; }
        .time-group > div { flex: 1; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        
        // ** CONFIGURACIÓN DE FIREBASE **
        const firebaseConfig = {
            // ¡ATENCIÓN! REEMPLAZA ESTOS VALORES CON TU CONFIGURACIÓN REAL DE FIREBASE
            apiKey: "AIzaSyAN8piM_UR3kLDUnJFYe5diazItfvYIlSA",
            authDomain: "lazonadelbarbero-b4e75.firebaseapp.com",
            databaseURL: "https://lazonadelbarbero-b4e75-default-rtdb.firebaseio.com",
            projectId: "lazonadelbarbero-b4e75",
            storageBucket: "lazonadelbarbero-b4e75.firebasestorage.app",
            messagingSenderId: "251180096928",
            appId: "1:251180096928:web:86d0ab83c7e444af79d8c5"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ** LISTA DE BARBEROS (COPIADA DE agenda.html) **
        const BARBERS = {
          "Dilan": { phone: "573233489369", image: "20251206_084342.jpg" }, 
          "Alejandro": { phone: "573219621581", image: "20251205_175256.jpg" }, 
          "Leonardo": { phone: "573215676362", image: "20251205_130628.jpg" }, 
          "Santiago": { phone: "573022441609", image: "20251205_130541.jpg" }
        };

        // Referencias de elementos DOM
        const barberoSelect = document.getElementById('barberoSelect');
        const absenceDateInput = document.getElementById('absenceDate');
        const absenceTypeSelect = document.getElementById('absenceType');
        const absenceTimeStartInput = document.getElementById('absenceTimeStart');
        const absenceTimeEndInput = document.getElementById('absenceTimeEnd');    
        const absenceTimeGroup = document.getElementById('absenceTimeGroup');
        const absenceReasonInput = document.getElementById('absenceReason'); 
        const markAbsenceBtn = document.getElementById('markAbsenceBtn');
        const absenceMessageEl = document.getElementById('absenceMessage');
        const absencesListEl = document.getElementById('absencesList');

        // Función para mostrar mensajes
        function showMessage(el, type, text) {
            el.className = `message ${type}`;
            el.textContent = text;
            setTimeout(() => el.textContent = '', 5000);
        }
        
        // Conversión de minutos a hora HH:MM AM/PM
        function minutesToTime(m) {
            const h = Math.floor(m / 60);
            const mi = m % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${String(mi).padStart(2, '0')} ${ampm}`;
        }
        
        // Conversión de hora HH:MM a minutos
        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return (h * 60) + m;
        }

        // Función para obtener la fecha actual en formato YYYY-MM-DD
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        // Inicializar campos de fecha y hora
        absenceDateInput.value = getCurrentDate();
        absenceTimeStartInput.value = '09:00';
        absenceTimeEndInput.value = '10:00'; 

        // Ocultar/Mostrar selector de hora según el tipo de ausencia
        absenceTypeSelect.addEventListener('change', () => {
            absenceTimeGroup.style.display = absenceTypeSelect.value === 'hour' ? 'block' : 'none';
        });
        
        // -------------------------------------------------------------
        // FUNCIÓN: Creación de Ausencias 
        // -------------------------------------------------------------
        async function createAbsence() {
            const barbero = barberoSelect.value;
            const date = absenceDateInput.value; // <-- Aquí se lee la fecha
            const type = absenceTypeSelect.value;
            
            const motivo = absenceReasonInput.value.trim() || (type === 'day' ? 'Día no disponible.' : 'Bloqueo temporal por horas.'); 
            
            if (!barbero || !date || !type) {
                showMessage(absenceMessageEl, 'error', 'Por favor, selecciona un barbero, una fecha y un tipo de ausencia.');
                return;
            }

            markAbsenceBtn.disabled = true;
            markAbsenceBtn.textContent = 'Guardando...';

            try {
                const absenceNodeRef = ref(db, `absences/${barbero}/${date}`);
                
                if (type === 'day') {
                    // Marcar día completo
                    await set(absenceNodeRef, {
                        isFullDay: true,
                        reason: motivo,
                        createdAt: Date.now()
                    });
                    showMessage(absenceMessageEl, 'success', `Ausencia de día completo marcada: ${motivo}`);
                } 
                
                else if (type === 'hour') {
                    // Marcar intervalo de hora personalizado
                    const timeStart = absenceTimeStartInput.value;
                    const timeEnd = absenceTimeEndInput.value;

                    if (!timeStart || !timeEnd) {
                         showMessage(absenceMessageEl, 'error', 'Debes seleccionar una hora de inicio y una hora de finalización.');
                         markAbsenceBtn.disabled = false;
                         markAbsenceBtn.textContent = 'Marcar Ausencia';
                         return;
                    }
                    
                    const startMinutes = timeToMinutes(timeStart);
                    const endMinutes = timeToMinutes(timeEnd);

                    if (startMinutes >= endMinutes) {
                         showMessage(absenceMessageEl, 'error', 'La hora de inicio debe ser anterior a la hora final.');
                         markAbsenceBtn.disabled = false;
                         markAbsenceBtn.textContent = 'Marcar Ausencia';
                         return;
                    }
                    
                    const interval = {
                        start: startMinutes,
                        end: endMinutes,
                        reason: motivo
                    };

                    await runTransaction(absenceNodeRef, (currentData) => {
                        if (currentData && currentData.isFullDay) {
                            throw new Error('Full day absence already set. Cannot add hourly block.');
                        }
                        
                        if (currentData === null) {
                            currentData = { intervals: [] };
                        }
                        if (!currentData.intervals) {
                            currentData.intervals = [];
                        }
                        
                        // Añadir el nuevo intervalo
                        currentData.intervals.push(interval);
                        return currentData;
                    });
                    
                    showMessage(absenceMessageEl, 'success', `Bloqueo de ${minutesToTime(startMinutes)} a ${minutesToTime(endMinutes)} marcado: ${motivo}`);
                }

                absenceReasonInput.value = ''; 
                await displayAbsences(barbero); 
            } catch(error) {
                console.error("Error creating absence:", error);
                let message = 'Error al marcar la ausencia.';
                if (error.message.includes('Full day absence')) {
                    message = 'Ya existe una ausencia de día completo para esta fecha. No se puede añadir un bloqueo por hora.';
                }
                showMessage(absenceMessageEl, 'error', message);
            } finally {
                markAbsenceBtn.disabled = false;
                markAbsenceBtn.textContent = 'Marcar Ausencia';
            }
        }
        
        markAbsenceBtn.addEventListener('click', createAbsence);

        // -------------------------------------------------------------
        // FUNCIÓN: Mostrar Ausencias Registradas
        // -------------------------------------------------------------
        async function displayAbsences(barbero) {
            absencesListEl.innerHTML = '';
            
            const absencesRef = ref(db, `absences/${barbero}`);
            const snapshot = await get(absencesRef);
            
            if (snapshot.exists()) {
                let foundAbsences = false;
                
                // Ordenar por fecha antes de iterar
                Object.entries(snapshot.val()).sort(([dateA], [dateB]) => dateA.localeCompare(dateB)).forEach(([date, data]) => {
                    
                    // 1. Ausencia de Día Completo
                    if (data.isFullDay) {
                        foundAbsences = true;
                        const motivo = data.reason || 'Día no disponible';
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>**DÍA COMPLETO**: ${date} - Motivo: ${motivo}</span>
                            <button class="btn btn-danger" data-type="day" data-date="${date}" onclick="removeAbsence(this)">Eliminar</button>
                        `;
                        absencesListEl.appendChild(li);
                    }

                    // 2. Ausencias por Intervalos
                    if (data.intervals && Array.isArray(data.intervals)) {
                        data.intervals.forEach((interval, index) => {
                            foundAbsences = true;
                            const startTime = minutesToTime(interval.start);
                            const endTime = minutesToTime(interval.end);
                            const motivo = interval.reason || 'Bloqueo temporal';

                            const li = document.createElement('li');
                            li.innerHTML = `
                                <span>HORA: ${date} de ${startTime} a ${endTime} - Motivo: ${motivo}</span>
                                <button class="btn btn-danger" data-type="hour" data-date="${date}" data-index="${index}" onclick="removeAbsence(this)">Eliminar</button>
                            `;
                            absencesListEl.appendChild(li);
                        });
                    }
                });
                
                if(!foundAbsences) {
                    absencesListEl.innerHTML = '<p>No hay ausencias registradas para este barbero.</p>';
                }
            } else {
                absencesListEl.innerHTML = '<p>No hay ausencias registradas para este barbero.</p>';
            }
        }
        
        // Listener para cargar ausencias al cambiar el barbero
        barberoSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                displayAbsences(e.target.value);
            } else {
                absencesListEl.innerHTML = '';
            }
        });

        // -------------------------------------------------------------
        // FUNCIÓN: Eliminación de Ausencias
        // -------------------------------------------------------------
        window.removeAbsence = async (button) => { 
            const barbero = barberoSelect.value;
            if (!barbero) return;

            const type = button.dataset.type;
            const date = button.dataset.date;
            
            button.disabled = true;
            button.textContent = '...';
            
            try {
                const absenceNodeRef = ref(db, `absences/${barbero}/${date}`);
                
                if (type === 'day') {
                    // Eliminar la entrada completa del día
                    await remove(absenceNodeRef);
                    showMessage(absenceMessageEl, 'success', `Ausencia de día completo (${date}) eliminada.`);
                } 
                
                else if (type === 'hour') {
                    // Eliminar un intervalo específico del array usando runTransaction
                    const indexToRemove = parseInt(button.dataset.index);
                    
                    await runTransaction(absenceNodeRef, (currentData) => {
                        if (currentData === null || !currentData.intervals || !Array.isArray(currentData.intervals)) {
                            return currentData; 
                        }
                        
                        const newIntervals = currentData.intervals.filter((_, index) => index !== indexToRemove);
                        
                        // Si el array queda vacío Y NO es una ausencia de día completo, eliminamos el nodo del día
                        if (newIntervals.length === 0 && !currentData.isFullDay) {
                            return null; 
                        }
                        
                        currentData.intervals = newIntervals;
                        return currentData; 
                    });
                    
                    showMessage(absenceMessageEl, 'success', `Bloqueo horario (${date}) eliminado.`);
                }

                await displayAbsences(barbero); 
            } catch(error) {
                console.error("Error deleting absence:", error);
                showMessage(absenceMessageEl, 'error', 'Error al eliminar la ausencia.');
            } finally {
                if(button.textContent === '...') {
                    button.disabled = false;
                    button.textContent = 'Eliminar';
                }
            }
        }
        
        // -------------------------------------------------------------
        // FUNCIÓN: Inicialización del Barbero Select
        // -------------------------------------------------------------
        function setupBarberoSelect(){
             barberoSelect.innerHTML = '<option value="">-- Selecciona un Barbero --</option>';
             for(const name in BARBERS){
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                barberoSelect.appendChild(opt);
             }
        }

        // Inicialización
        setupBarberoSelect();

    </script>
</head>
<body>
    <div class="container">
        <h1>Panel de Administración</h1>

        <div class="card">
            <h2>Seleccionar Barbero</h2>
            <div class="input-group">
                <label for="barberoSelect">Barbero:</label>
                <select id="barberoSelect">
                    <option value="">-- Selecciona un Barbero --</option>
                    </select>
            </div>
        </div>

        <div class="card">
            <h2>Marcar Ausencia</h2>
            <div id="absenceMessage"></div>
            
            <div class="input-group">
                <label for="absenceDate">Fecha:</label>
                <input type="date" id="absenceDate"> 
            </div>

            <div class="input-group">
                <label for="absenceType">Tipo de Ausencia:</label>
                <select id="absenceType">
                    <option value="day">Día Completo (Bloquea todo el día)</option>
                    <option value="hour">Bloqueo por Horas (Intervalo)</option>
                </select>
            </div>
            
            <div class="input-group" id="absenceTimeGroup" style="display: none;">
                <div class="time-group">
                    <div>
                        <label for="absenceTimeStart">Hora de Inicio:</label>
                        <input type="time" id="absenceTimeStart" step="300" value="09:00"> 
                    </div>
                    <div>
                        <label for="absenceTimeEnd">Hora de Finalización:</label>
                        <input type="time" id="absenceTimeEnd" step="300" value="10:00"> 
                    </div>
                </div>
                <div class="small">Selecciona el rango exacto que debe ser bloqueado para agendamiento.</div>
            </div>

            <div class="input-group">
                <label for="absenceReason">Motivo de la Ausencia (Opcional):</label>
                <textarea id="absenceReason" placeholder="Vacaciones, cita médica, festivo, etc. Este motivo aparecerá en la agenda." rows="2"></textarea>
            </div>
            
            <button id="markAbsenceBtn" class="btn btn-primary" style="background-color: var(--danger);">Marcar Ausencia</button>
        </div>

        <div class="card">
            <h2>Ausencias Registradas</h2>
            <ul class="absences-list" id="absencesList">
                <p>Selecciona un barbero para ver las ausencias.</p>
            </ul>
        </div>
    </div>
</body>
</html>
